import{e as ee,d as te,f as A,_ as S,N as D,az as ae,r as T,bA as M,w as re,ao as oe,aE as se,o as P,a as H,F as ne,j as Y,u as w,g as ie}from"./index.db4b08e0.js";import le from"./TSpinner.f247bbba.js";import{d as _}from"./dayjs.min.cf2eabef.js";import{i as ce}from"./id.f45f6e07.js";import{s as L}from"./socket.2fbb088b.js";import{m as ue}from"./mutation.640962a3.js";import{n as q}from"./index.browser.8e74d592.js";var W={exports:{}};(function(f,h){(function(N,i){f.exports=i()})(ee,function(){return{name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")}})})(W);const me=W.exports,$=f=>{if(!f)return;_.locale("en");const h={};return Object.keys(f).map(i=>_(i).toDate().getTime()).sort().map(i=>_(i).format("D MMM YYYY")).forEach(i=>{h[i]=f[i]}),h},pe={class:"sc-conversation"},be=te({__name:"TRoomConversation",setup(f){const h=A({loader:()=>S(()=>import("./SectionConvUser.226cc506.js"),["assets/SectionConvUser.226cc506.js","assets/SectionConvUser.538c9759.css","assets/index.db4b08e0.js","assets/index.44fe606f.css","assets/socket.2fbb088b.js"]),loadingComponent:D}),N=A({loader:()=>S(()=>import("./SectionConvList.5fac1d93.js"),["assets/SectionConvList.5fac1d93.js","assets/SectionConvList.119c2b3b.css","assets/dayjs.min.cf2eabef.js","assets/index.db4b08e0.js","assets/index.44fe606f.css","assets/id.f45f6e07.js","assets/mutation.640962a3.js","assets/TSpinner.f247bbba.js","assets/TSpinner.554126ed.css","assets/Image.830a7497.js","assets/fade-in-scale-up.cssr.6fe20355.js","assets/Tooltip.c677ca6c.js","assets/Popover.9be5e582.js","assets/index.eb8c481c.js","assets/use-compitable.ba41904e.js","assets/utils.5839b03b.js","assets/use-merged-state.119a85f6.js","assets/use-locale.145fb545.js","assets/messagePayload.54e5d9ee.js"]),loadingComponent:D}),i=A({loader:()=>S(()=>import("./SectionConvInput.8be3066f.js"),["assets/SectionConvInput.8be3066f.js","assets/SectionConvInput.c008d3ea.css","assets/index.db4b08e0.js","assets/index.44fe606f.css","assets/mutation.640962a3.js","assets/messagePayload.54e5d9ee.js","assets/socket.2fbb088b.js","assets/Scrollbar.dadac60d.js","assets/index.browser.8e74d592.js","assets/Popover.9be5e582.js","assets/index.eb8c481c.js","assets/use-compitable.ba41904e.js","assets/utils.5839b03b.js","assets/use-merged-state.119a85f6.js","assets/Input.a8ee46ca.js","assets/use-locale.145fb545.js","assets/Modal.2d2a379b.js","assets/use-is-composing.342a80f5.js","assets/fade-in-scale-up.cssr.6fe20355.js","assets/index.20db2190.js","assets/TSpinner.f247bbba.js","assets/TSpinner.554126ed.css","assets/Select.74374ef8.js"]),loadingComponent:D});_.locale(ce);const b=ae(),U=T(!1),v=M({username:"",avatar:"",status:"offline"}),a=T({}),O=T(!1),j=T(),x=T(),p=M({page:1,perPage:10}),E=M({}),F=s=>{Object.entries(a.value).forEach(([n,u])=>{a.value[n]=u.map(m=>m.messageId===s.event.msg_id?{...m,isRead:!!s.event.is_opposite}:m)})},V=s=>{const{timestamp:n}=s.event.message,{is_opposite:u,msg_id:m,attachment:t,message:l,attachment_id:I,parent_reply:k,from_uid:R,source:y}=s.event;if(m===Number(b.query.chat)){_.locale(me);const d=_(n).format("D MMM YYYY"),r=_(n).format("HH:mm");a.value[d]||(a.value={[d]:[],...a.value});const o={attachmentId:I,messageId:m,shopId:Number(s.shopid),isOpposite:u,message:l.original_reply,parsedTimestamp:r,isRead:!1,id:q(),replyTime:n,from:E[R],fromId:R,source:y};if(t!=null&&t.attributes.product_profile){const c=t.attributes.product_profile;o.type="product",o.directAttachment={product:{image:c.image_url||"",name:c.name,price:c.price,productId:c.shop_id,redirect:c.url,remaining_stock:c.remaining_stock,variant:c.variant}}}t!=null&&t.attributes.sticker_profile&&(o.type="sticker",o.directAttachment={sticker:{imageUrl:t.attributes.sticker_profile.image_url,title:t.attributes.sticker_profile.intention}}),k&&(o.type="reply",o.directAttachment={reply:{mainText:k.main_text,from:E[k.sender_id],content:l.original_reply}}),(t==null?void 0:t.attributes.image_url)&&(t==null?void 0:t.attributes.image_url_thumbnail)&&(o.type="image",o.directAttachment={image:{src:t.attributes.image_url,title:t.attributes.image_url}}),a.value[d].indexOf(o)<0&&a.value[d].push(o);const C=$(a.value);C&&(a.value=C),j.value=q()}},z=(s,n,u,m,t)=>{ue("getListChat","chat/messages","POST",{isTextOnly:!0,keyword:"",messageId:n,page:u,perPage:m,beforeReplyTime:x.value},null,{onSuccess:({data:l})=>{const{contacts:I,list:k,minReplyTime:R}=l.chatReplies,y=I.filter(r=>r.interlocutor);x.value=R,I.forEach(r=>{E[r.userId]=r.name}),y[0]&&(v.avatar=y[0].thumbnail,v.username=y[0].name,v.status=y[0].status.isOnline?"Online":"Offline"),t==="first"&&(a.value={}),k.forEach(({date:r,chats:o})=>{o.forEach(C=>{const{messages:c,time:Q}=C;console.log(r,"api"),c.forEach(e=>{var B,J,G;a.value[r]||(a.value[r]=[]);const g={attachmentId:e.attachmentId,isOpposite:e.isOpposite,message:e.message,messageId:e.messageId,parsedTimestamp:Q,shopId:Number(b.query.shop),isRead:e.isRead,replyTime:e.replyTime,id:q(),fromId:e.senderId,from:((B=e.role)==null?void 0:B.toLowerCase())==="shop owner"?"Saya":e.senderName,source:e.source};e.parentReply&&(g.type="reply",g.directAttachment={reply:{mainText:e.parentReply.mainText,from:e.parentReply.name,content:e.message}}),(G=(J=e.attachment.fallback)==null?void 0:J.message)!=null&&G.includes("mengirimkan gambar menggunakan")&&(g.type="image"),e.message===e.attachment.fallback.message&&e.source!=="tx_ask_buyer"&&(g.type="sticker"),e.message!==e.attachment.fallback.message&&e.message.includes("https")&&(g.type="product"),a.value[r].push(g),a.value[r]=a.value[r].sort((X,Z)=>Number(X.replyTime)-Number(Z.replyTime))})})});const d=$(a.value);d&&(a.value=d)},onLoading:l=>{t==="first"?U.value=l:O.value=l}},l=>l+`?shopid=${s}`)},K=()=>{O.value||(p.page=p.page+1,x.value&&z(Number(b.query.shop),Number(b.query.chat),p.page,p.perPage,"next"))};return re(()=>b.query,s=>{const{chat:n,shop:u}=s;n&&u&&(p.page=1,x.value=void 0,z(Number(u),Number(n),p.page,p.perPage,"first"))},{immediate:!0}),oe(()=>{L.on("rcv_message",V),L.on("rcv_read_event",F)}),se(()=>{L.off("rcv_read_event",F),L.off("rcv_message",V)}),(s,n)=>(P(),H("div",pe,[U.value?(P(),ie(le,{key:1,"text-color":"#333",style:{height:"100%","z-index":"99"},size:"large",text:"Sedang memuat chat..."})):(P(),H(ne,{key:0},[Y(w(h),{avatar:v.avatar,username:v.username,status:v.status,class:"fades"},null,8,["avatar","username","status"]),Y(w(N),{onLoadNext:K,"loading-load-next":O.value,"scroll-token":j.value,data:a.value,class:"fades"},null,8,["loading-load-next","scroll-token","data"]),Y(w(i),{class:"fades"})],64))]))}});export{be as default};
